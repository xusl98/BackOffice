<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual GolfClapp BackOffice Calendar</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f2f5;
        }
        header {
            background-color: #fff;
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        header h1 {
            margin: 0;
            color: #333;
        }
        nav.tabs {
            display: flex;
            background-color: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }
        .tab-button {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1rem;
            color: #555;
            transition: background-color 0.3s, color 0.3s;
        }
        .tab-button.active {
            background-color: #e9ecef;
            border-bottom: 2px solid #007bff;
            color: #007bff;
        }
        .tab-button:hover:not(.active) {
            background-color: #e2e6ea;
        }
        .tab-content {
            padding: 2rem;
        }
        .course-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .course-list-item {
            padding: 15px;
            background-color: #fff;
            border-bottom: 1px solid #ddd;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .course-list-item:hover {
            background-color: #f0f0f0;
        }
        .course-list-item:last-child {
            border-bottom: none;
        }
        .main-content-wrapper {
            display: flex;
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            flex-wrap: wrap;
        }
        .calendar-container {
            flex: 2;
            min-width: 600px;
            margin-top: 2rem;
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .price-summary-card {
            flex: 1;
            min-width: 300px;
            margin-top: 2rem;
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 700px;
            overflow-y: auto;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .calendar-header button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 1rem;
        }
        .calendar-header button:hover {
            background: #0056b3;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .day-name, .day {
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .day-name {
            background-color: #e9ecef;
            font-weight: bold;
        }
        .day {
            background-color: #f8f9fa;
            position: relative;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            cursor: pointer;
        }
        .day-number {
            font-weight: bold;
            font-size: 1.2rem;
        }
        .event {
            font-size: 0.75rem;
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            margin-top: 5px;
            width: 90%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        .tab-content h2 {
            text-align: center;
        }
        .price-summary-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .price-summary-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .price-summary-item:hover {
            background-color: #f8f9fa;
        }
        .price-summary-item:last-child {
            border-bottom: none;
        }
        .color-dot {
            height: 12px;
            width: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-form label, .modal-form input, .modal-form p, .modal-form button {
            margin-bottom: 15px;
            display: block;
            width: 100%;
            box-sizing: border-box;
        }
        .modal-form input[type="number"], .modal-form input[type="date"], .modal-form input[type="time"] {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .modal-form button {
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        .modal-form button.save-btn {
            background-color: #007bff;
            color: white;
        }
        .modal-form button.cancel-btn {
            background-color: #ccc;
            color: #333;
        }
        .modal-form button.delete-btn {
            background-color: #dc3545;
            color: white;
        }
        .modal-form button:hover {
            opacity: 0.9;
        }
        .modal-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
        }
    </style>
</head>
<body>

    <header>
        <h1>GolfClapp BackOffice</h1>
    </header>

    <nav class="tabs">
        <button class="tab-button active">Precios</button>
        <button class="tab-button">...</button>
    </nav>

    <main class="tab-content">
        <h2>Precios</h2>
        <div id="prices-container">
            <p id="loading-message">Loading courses...</p>
            <ul id="course-list" class="course-list"></ul>
            <div id="calendar-wrapper">
                 <h3 id="selected-course-name" style="text-align: center;"></h3>
                 <div class="main-content-wrapper">
                    <div class="calendar-container">
                        <div class="calendar-header">
                            <button id="prev-btn">Prev</button>
                            <span id="month-year-display"></span>
                            <button id="next-btn">Next</button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            <div class="day-name">Sun</div>
                            <div class="day-name">Mon</div>
                            <div class="day-name">Tue</div>
                            <div class="day-name">Wed</div>
                            <div class="day-name">Thu</div>
                            <div class="day-name">Fri</div>
                            <div class="day-name">Sat</div>
                        </div>
                    </div>
                    <div class="price-summary-card">
                        <h3>Current Month Prices</h3>
                        <ul id="price-summary-list" class="price-summary-list">
                            <li>Select a course to view prices.</li>
                        </ul>
                        <button id="create-new-btn">Create New Price Range</button>
                    </div>
                 </div>
            </div>
        </div>
    </main>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2>Edit Price Range</h2>
            <form id="editForm" class="modal-form">
                <input type="hidden" id="editPriceRangeId">
                <p><strong>Course:</strong> <span id="editCourseName"></span></p>
                <p><strong>Current Price:</strong> <span id="currentPriceDisplay"></span></p>
                <p>
                    <label for="newPrice">New Price (€):</label>
                    <input type="number" id="newPrice" name="newPrice" step="0.01" required>
                </p>
                <p>
                    <label for="startDate">Start Date:</label>
                    <input type="date" id="startDate" name="startDate" required>
                </p>
                <p>
                    <label for="startTime">Start Time:</label>
                    <input type="time" id="startTime" name="startTime" required>
                </p>
                <p>
                    <label for="endDate">End Date:</label>
                    <input type="date" id="endDate" name="endDate" required>
                </p>
                <p>
                    <label for="endTime">End Time:</label>
                    <input type="time" id="endTime" name="endTime" required>
                </p>
                <div class="modal-buttons">
                    <button type="submit" class="save-btn">Save Changes</button>
                    <button type="button" class="delete-btn" id="delete-btn">Delete</button>
                    <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="dayInfoModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeDayInfoModal()">&times;</span>
            <h2>Price Ranges for <span id="dayInfoDate"></span></h2>
            <ul id="dayInfoList">
                </ul>
        </div>
    </div>

    <script>
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let currentCourseData = null;

        document.addEventListener('DOMContentLoaded', () => {
            const apiKey = localStorage.getItem('apiKey');
            if (!apiKey) {
                alert('You must be logged in to view this page.');
                window.location.href = 'login.html';
                return;
            }

            fetchCourseList(apiKey);

            document.getElementById('prev-btn').addEventListener('click', () => {
                currentMonth--;
                if (currentMonth < 0) {
                    currentMonth = 11;
                    currentYear--;
                }
                renderCalendar();
            });

            document.getElementById('next-btn').addEventListener('click', () => {
                currentMonth++;
                if (currentMonth > 11) {
                    currentMonth = 0;
                    currentYear++;
                }
                renderCalendar();
            });

            document.getElementById('create-new-btn').addEventListener('click', () => {
                if (currentCourseData) {
                    openEditModal(null);
                } else {
                    alert('Please select a course first.');
                }
            });
        });

        async function fetchCourseList(userApiKey) {
            const url = 'https://golfclappapi.azurewebsites.net//BackOffice/GetPriceRanges';
            const loadingMessage = document.getElementById('loading-message');
            const courseListEl = document.getElementById('course-list');
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Api-Key': userApiKey,
                    },
                });
                if (response.ok) {
                    const data = await response.json();
                    loadingMessage.style.display = 'none';
                    
                    if (data.length > 0) {
                        currentCourseData = data[0];
                        document.getElementById('selected-course-name').textContent = `Price Ranges for: ${currentCourseData.course.name}`;
                        renderCalendar();
                    }

                    data.forEach(courseData => {
                        const listItem = document.createElement('li');
                        listItem.classList.add('course-list-item');
                        listItem.textContent = courseData.course.name;
                        listItem.dataset.courseId = courseData.course.id;
                        listItem.addEventListener('click', () => {
                            selectCourseAndRenderCalendar(courseData);
                        });
                        courseListEl.appendChild(listItem);
                    });
                } else {
                    console.error('Failed to get course list:', response.status);
                    loadingMessage.textContent = 'Failed to load courses.';
                }
            } catch (error) {
                console.error('Network or other error:', error);
                loadingMessage.textContent = 'An error occurred. Please try again.';
            }
        }

        function selectCourseAndRenderCalendar(courseData) {
            currentCourseData = courseData;
            document.getElementById('selected-course-name').textContent = `Price Ranges for: ${courseData.course.name}`;
            currentMonth = new Date().getMonth(); 
            currentYear = new Date().getFullYear();
            renderCalendar();
            
            const calendarWrapper = document.getElementById('calendar-wrapper');
            calendarWrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function stringToHslColor(str, s, l) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            const h = hash % 360;
            return 'hsl(' + h + ', ' + s + '%, ' + l + '%)';
        }

        function renderCalendar() {
            if (!currentCourseData) return;

            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const firstDay = new Date(currentYear, currentMonth, 1);
            const lastDay = new Date(currentYear, currentMonth + 1, 0);
            const numDays = lastDay.getDate();

            const displayEl = document.querySelector('.calendar-container .calendar-header span');
            const gridEl = document.getElementById('calendar-grid');

            displayEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;

            while (gridEl.children.length > 7) {
                gridEl.removeChild(gridEl.lastChild);
            }

            const firstDayOfWeek = firstDay.getDay();
            for (let i = 0; i < firstDayOfWeek; i++) {
                const blankDay = document.createElement('div');
                blankDay.classList.add('day');
                gridEl.appendChild(blankDay);
            }

            for (let day = 1; day <= numDays; day++) {
                const dayEl = document.createElement('div');
                dayEl.classList.add('day');
                dayEl.innerHTML = `<span class="day-number">${day}</span>`;
                
                dayEl.addEventListener('click', () => {
                    openDayInfoModal(day);
                });

                const currentDateString = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                currentCourseData.priceRanges.forEach(priceRange => {
                    const startDate = priceRange.startDate.split('T')[0];
                    const endDate = priceRange.endDate.split('T')[0];
                    
                    if (currentDateString >= startDate && currentDateString <= endDate) {
                        const eventEl = document.createElement('div');
                        eventEl.classList.add('event');
                        eventEl.textContent = `€${(priceRange.price / 100).toFixed(2)}`;
                        
                        const priceKey = priceRange.price.toString();
                        eventEl.style.backgroundColor = stringToHslColor(priceKey, 70, 50);

                        eventEl.addEventListener('click', (e) => {
                            e.stopPropagation();
                            openEditModal(priceRange);
                        });

                        dayEl.appendChild(eventEl);
                    }
                });

                gridEl.appendChild(dayEl);
            }
            renderPriceSummary();
        }

        function renderPriceSummary() {
            const summaryListEl = document.getElementById('price-summary-list');
            summaryListEl.innerHTML = '';

            if (!currentCourseData || !currentCourseData.priceRanges) {
                summaryListEl.innerHTML = '<li>No price ranges available for this course.</li>';
                return;
            }

            const pricesForMonth = currentCourseData.priceRanges.filter(range => {
                const start = new Date(range.startDate);
                const end = new Date(range.endDate);
                
                const currentMonthStart = new Date(currentYear, currentMonth, 1);
                const currentMonthEnd = new Date(currentYear, currentMonth + 1, 0);

                return (start <= currentMonthEnd && end >= currentMonthStart);
            });
            
            pricesForMonth.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            if (pricesForMonth.length > 0) {
                pricesForMonth.forEach(range => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('price-summary-item');
                    
                    listItem.priceRangeData = range;

                    const priceKey = range.price.toString();
                    const color = stringToHslColor(priceKey, 70, 50);

                    const startDate = new Date(range.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const endDate = new Date(range.endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    
                    listItem.innerHTML = `
                        <span class="color-dot" style="background-color: ${color};"></span>
                        <strong>€${(range.price / 100).toFixed(2)}</strong>: ${startDate} - ${endDate}
                    `;
                    
                    listItem.addEventListener('click', () => {
                        openEditModal(range);
                    });

                    summaryListEl.appendChild(listItem);
                });
            } else {
                summaryListEl.innerHTML = '<li>No price ranges for this month.</li>';
            }
        }

        function openEditModal(priceRange) {
            const modal = document.getElementById('editModal');
            const form = document.getElementById('editForm');
            const deleteBtn = document.getElementById('delete-btn');
            
            const isNew = priceRange === null;
            document.getElementById('editPriceRangeId').value = isNew ? '' : priceRange.id;
            document.getElementById('editCourseName').textContent = currentCourseData.course.name;
            document.getElementById('currentPriceDisplay').textContent = isNew ? 'N/A' : `€${(priceRange.price / 100).toFixed(2)}`;
            
            document.getElementById('newPrice').value = isNew ? '0.00' : (priceRange.price / 100).toFixed(2);
            
            deleteBtn.style.display = isNew ? 'none' : 'block';

            if (isNew) {
                const today = new Date();
                const tomorrow = new Date();
                tomorrow.setDate(today.getDate() + 1);

                document.getElementById('startDate').value = today.toISOString().split('T')[0];
                document.getElementById('startTime').value = '00:00';
                document.getElementById('endDate').value = tomorrow.toISOString().split('T')[0];
                document.getElementById('endTime').value = '23:59';
            } else {
                const startDateObj = new Date(priceRange.startDate);
                const endDateObj = new Date(priceRange.endDate);
                
                document.getElementById('startDate').value = startDateObj.toISOString().split('T')[0];
                document.getElementById('startTime').value = startDateObj.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
                document.getElementById('endDate').value = endDateObj.toISOString().split('T')[0];
                document.getElementById('endTime').value = endDateObj.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
            }

            modal.style.display = 'block';

            deleteBtn.onclick = async () => {
                if (confirm('Are you sure you want to delete this price range?')) {
                    await deletePriceRange(priceRange.id);
                }
            };
            
            form.onsubmit = async (event) => {
                event.preventDefault();
                
                const updatedPrice = parseFloat(document.getElementById('newPrice').value) * 100;
                const newDateStart = document.getElementById('startDate').value;
                const newTimeStart = document.getElementById('startTime').value;
                const newDateEnd = document.getElementById('endDate').value;
                const newTimeEnd = document.getElementById('endTime').value;
                let priceRangeId = document.getElementById('editPriceRangeId').value;
                
                const updatedStartDate = `${newDateStart}T${newTimeStart}:00.000Z`;
                const updatedEndDate = `${newDateEnd}T${newTimeEnd}:00.000Z`;
                
                if (isNew) {
                    priceRangeId = crypto.randomUUID();
                }

                const updateData = {
                    id: priceRangeId,
                    price: updatedPrice,
                    startDate: updatedStartDate,
                    endDate: updatedEndDate,
                    courseId: currentCourseData.course.id
                };
                
                const url = 'https://golfclappapi.azurewebsites.net//BackOffice/UpdatePriceRange';
                const apiKey = localStorage.getItem('apiKey');
                
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Api-Key': apiKey,
                        },
                        body: JSON.stringify(updateData),
                    });
                    
                    if (response.ok) {
                        alert('Price range saved successfully!');
                        closeModal();
                        
                        if (isNew) {
                            currentCourseData.priceRanges.push(updateData);
                        } else {
                            const index = currentCourseData.priceRanges.findIndex(p => p.id === priceRangeId);
                            if (index !== -1) {
                                currentCourseData.priceRanges[index].price = updatedPrice;
                                currentCourseData.priceRanges[index].startDate = updatedStartDate;
                                currentCourseData.priceRanges[index].endDate = updatedEndDate;
                            }
                        }
                        
                        renderCalendar();
                    } else {
                        const error = await response.text();
                        alert('Failed to save price range: ' + error);
                    }
                } catch (error) {
                    alert('An error occurred while saving the price range.');
                    console.error(error);
                }
            };
        }

        async function deletePriceRange(priceRangeId) {
            const url = `https://golfclappapi.azurewebsites.net//BackOffice/DeletePriceRange?id=${priceRangeId}`;
            const apiKey = localStorage.getItem('apiKey');

            try {
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Api-Key': apiKey,
                    },
                });

                if (response.ok) {
                    alert('Price range deleted successfully!');
                    closeModal();
                    
                    currentCourseData.priceRanges = currentCourseData.priceRanges.filter(p => p.id !== priceRangeId);
                    
                    renderCalendar();
                } else {
                    const error = await response.text();
                    alert('Failed to delete price range: ' + error);
                }
            } catch (error) {
                alert('An error occurred while deleting the price range.');
                console.error(error);
            }
        }

        function closeModal() {
            const modal = document.getElementById('editModal');
            modal.style.display = 'none';
        }
        
        function openDayInfoModal(day) {
            const modal = document.getElementById('dayInfoModal');
            const dateEl = document.getElementById('dayInfoDate');
            const listEl = document.getElementById('dayInfoList');
            
            const selectedDate = new Date(currentYear, currentMonth, day);
            dateEl.textContent = selectedDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            listEl.innerHTML = '';
            const dayString = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            const pricesForDay = currentCourseData.priceRanges.filter(range => {
                const startDate = range.startDate.split('T')[0];
                const endDate = range.endDate.split('T')[0];
                return dayString >= startDate && dayString <= endDate;
            });

            if (pricesForDay.length > 0) {
                pricesForDay.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));
                pricesForDay.forEach(range => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('price-summary-item');
                    
                    const priceKey = range.price.toString();
                    const color = stringToHslColor(priceKey, 70, 50);
                    
                    const startTime = new Date(range.startDate).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    const endTime = new Date(range.endDate).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    
                    listItem.innerHTML = `
                        <span class="color-dot" style="background-color: ${color};"></span>
                        <strong>€${(range.price / 100).toFixed(2)}</strong>: ${startTime} - ${endTime}
                    `;
                    
                    listItem.addEventListener('click', () => {
                        closeDayInfoModal();
                        openEditModal(range);
                    });
                    
                    listEl.appendChild(listItem);
                });
            } else {
                listEl.innerHTML = '<li>No price ranges for this day.</li>';
            }
            
            modal.style.display = 'block';
        }

        function closeDayInfoModal() {
            const modal = document.getElementById('dayInfoModal');
            modal.style.display = 'none';
        }
    </script>
</body>
</html>